import{d as J,u as j,a as oe,r as e,o as W,q as X,b as i,c as re,e as k,f as x,w as o,g as ue,h as D,i as a,j as m,k as R,l as z,s as O,m as ne,E as Y,n as A,t as T,p as ie,v as de,x as Z,y as pe,z as ee,A as ae,B as me,C as ce,D as ve,F as fe,G as ge,H as we,I as ye,J as he,K as Q,L as Ve,M as be,N as _e,O as $e,P as Me,_ as ke}from"./index-B6OoDg6B.js";const qe=J({name:"ChangePassword",__name:"ChangePassword",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null},setup(E,{emit:I}){const L=I,{t:c}=j(),g=oe(),n=e({}),y=e(),C=e(),v=e(!1),$=e(!1),h=e(""),_=e();W(async()=>{v.value=!0;try{h.value=await X()}finally{v.value=!1}});const M=()=>{y.value.validate(async r=>{if(r){$.value=!0;try{const d=O(n.value.password,h.value),u=O(n.value.newPassword,h.value),s=await ne({...n.value,password:d,newPassword:u,passwordAgain:void 0});if(s.status!==0){_.value=s.message;return}_.value=void 0,y.value.resetFields(),Y.success(c("success")),L("update:modelValue",!1)}finally{$.value=!1}}})};return(r,d)=>{const u=i("el-alert"),s=i("el-input"),w=i("el-form-item"),P=i("el-button"),V=i("el-form"),S=i("el-dialog"),U=re("loading");return k(),x(S,{title:r.$t("changePassword"),"model-value":E.modelValue,"onUpdate:modelValue":d[4]||(d[4]=p=>r.$emit("update:modelValue",p)),onOpened:d[5]||(d[5]=()=>{var p;(p=C.value)==null||p.focus(),y.value.resetFields()})},{default:o(()=>[ue((k(),x(V,{ref_key:"form",ref:y,model:n.value,"label-width":"150px","label-position":"right"},{default:o(()=>[_.value?(k(),x(u,{key:0,title:_.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):D("",!0),a(w,{prop:"username",label:r.$t("user.username"),rules:[{required:!0,message:()=>r.$t("v.required")}]},{default:o(()=>[a(s,{ref_key:"focus",ref:C,modelValue:n.value.username,"onUpdate:modelValue":d[0]||(d[0]=p=>n.value.username=p),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(w,{prop:"password",label:r.$t("user.origPassword"),rules:[{required:!0,message:()=>r.$t("v.required")}]},{default:o(()=>[a(s,{modelValue:n.value.password,"onUpdate:modelValue":d[1]||(d[1]=p=>n.value.password=p),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(w,{prop:"newPassword",label:r.$t("user.newPassword"),rules:[{required:!0,message:()=>r.$t("v.required")},{min:m(g).security.passwordMinLength,max:m(g).security.passwordMaxLength,message:()=>r.$t("user.error.passwordLength",{min:m(g).security.passwordMinLength,max:m(g).security.passwordMaxLength})},{pattern:new RegExp(m(g).security.passwordPattern),message:()=>r.$t("user.error.passwordPattern.".concat(m(g).security.passwordStrength))}]},{default:o(()=>[a(s,{modelValue:n.value.newPassword,"onUpdate:modelValue":d[2]||(d[2]=p=>n.value.newPassword=p),maxlength:m(g).security.passwordMaxLength,"show-password":""},null,8,["modelValue","maxlength"])]),_:1},8,["label","rules"]),a(w,{prop:"passwordAgain",label:r.$t("user.passwordAgain"),rules:[{required:!0,message:()=>r.$t("v.required")},{validator:(p,B,f)=>{if(B!==n.value.newPassword){f(r.$t("user.error.passwordNotMatch"));return}f()}}]},{default:o(()=>[a(s,{modelValue:n.value.passwordAgain,"onUpdate:modelValue":d[3]||(d[3]=p=>n.value.passwordAgain=p),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),R("div",null,[a(P,{loading:$.value,type:"primary","native-type":"submit",onClick:z(M,["prevent"])},{default:o(()=>[A(T(r.$t("submit")),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[U,v.value]])]),_:1},8,["title","model-value"])}}}),Ce=J({name:"GetShortMessage",__name:"GetShortMessage",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finish:null},setup(E,{emit:I}){const L=E,c=I,{modelValue:g}=ie(L),{t:n}=j(),y=e(),C=e(),v=e({}),$=e(!1),h=e(),_=e(),M=e(),r=async()=>{const{token:u,image:s}=await Z();_.value="data:image/png;base64,"+s,M.value=u};de(g,()=>{g.value&&r()});const d=()=>{y.value.validate(async u=>{var s;if(u){$.value=!0;try{const w=await me((s=M.value)!=null?s:"",v.value.captcha,v.value.mobile,3);if(w.status!==0){h.value=w.message;return}h.value=void 0,y.value.resetFields(),Y.success(n("success")),c("finish",w.result.shortMessageId),c("update:modelValue",!1)}finally{$.value=!1}}})};return(u,s)=>{const w=i("el-alert"),P=i("el-input"),V=i("el-form-item"),S=i("el-image"),U=i("el-button"),p=i("el-form"),B=i("el-dialog");return k(),x(B,{title:u.$t("getShortMessage"),"model-value":E.modelValue,width:"576px","onUpdate:modelValue":s[3]||(s[3]=f=>u.$emit("update:modelValue",f)),onOpened:s[4]||(s[4]=()=>{var f;(f=C.value)==null||f.focus(),y.value.resetFields()})},{default:o(()=>[a(p,{ref_key:"form",ref:y,model:v.value,"label-width":"150px","label-position":"right"},{default:o(()=>[h.value?(k(),x(w,{key:0,title:h.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):D("",!0),a(V,{prop:"mobile",label:u.$t("mobile"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(f,N,t)=>{if(await m(pe)(N)){t(u.$t("mobileNotExist"));return}t()},trigger:"blur"}]},{default:o(()=>[a(P,{ref_key:"focus",ref:C,modelValue:v.value.mobile,"onUpdate:modelValue":s[0]||(s[0]=f=>v.value.mobile=f),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(V,{prop:"captcha",label:u.$t("captcha"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(f,N,t)=>{if(M.value==null||!await m(ee)(M.value,N)){t(u.$t("captchaIncorrect"));return}t()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(P,{modelValue:v.value.captcha,"onUpdate:modelValue":s[2]||(s[2]=f=>v.value.captcha=f),name:"captcha",placeholder:u.$t("captcha"),"prefix-icon":m(ae)},{append:o(()=>[a(S,{src:_.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:u.$t("clickToRetrieveCaptcha"),onClick:s[1]||(s[1]=()=>r())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["label","rules"]),R("div",null,[a(U,{loading:$.value,type:"primary","native-type":"submit",onClick:z(d,["prevent"])},{default:o(()=>[A(T(u.$t("submit")),1)]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1},8,["title","model-value"])}}}),Pe={class:"h-full p-3 bg-gray-100"},Se={class:"py-5 text-3xl font-bold text-center text-primary"},xe={class:"mt-2 text-right"},Ie={key:0,class:"mt-5 text-sm text-center text-gray-secondary"},Le=J({__name:"LoginPage",setup(E){const{t:I}=j(),L=e(),c=e({}),g=e(),n=e(!1),y=e(!1),C=e(),v=e(),$=e(),h=e(),_=e(!1),M=e(),r=ce(),d=ve(),u="UJCMS",s="production",w=e(!1),P=e(!1),V=e(60),S=e(I("getShortMessage"));fe(),ge();const U=async()=>{const{token:t,image:l}=await Z();C.value="data:image/png;base64,"+l,v.value=t},p=async()=>{n.value=await we(),n.value&&U()},B=async()=>{y.value=await ye()};W(async()=>{g.value.focus(),g.value.select(),p(),B()}),he(()=>{M.value=r.query.redirect});const f=t=>{$.value=t,V.value-=1,S.value=String(V.value);const l=setInterval(()=>{V.value-=1,S.value=String(V.value),V.value<=0&&(S.value=I("getShortMessage"),V.value=60,clearInterval(l))},1e3)},N=()=>{L.value.validate(async t=>{if(t){_.value=!0;try{const l=await X(),G=O(c.value.password,l),q=await $e({...c.value,password:G,captchaToken:v.value,shortMessageId:$.value});if(q.status!==0){p(),h.value=q.message;return}q.result.remainingDays!=null&&Me.alert(I("passwordRemaingDays",{remainingDays:q.result.remainingDays}),{type:"warning"}),M.value?d.push(M.value):window.location.reload()}finally{_.value=!1}}})};return(t,l)=>{const G=i("el-alert"),q=i("el-input"),F=i("el-form-item"),K=i("el-button"),le=i("el-image"),se=i("el-form");return k(),Q("div",Pe,[R("h3",Se,T(m(u)),1),a(se,{ref_key:"form",ref:L,model:c.value,class:"mx-auto md:max-w-xs"},{default:o(()=>[h.value?(k(),x(G,{key:0,title:h.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):D("",!0),a(F,{prop:"username",rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(q,{ref_key:"focus",ref:g,modelValue:c.value.username,"onUpdate:modelValue":l[0]||(l[0]=b=>c.value.username=b),name:"username",placeholder:t.$t("username"),"prefix-icon":m(Ve),autocomplete:"on"},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),a(F,{prop:"password",rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(q,{ref:"password",modelValue:c.value.password,"onUpdate:modelValue":l[1]||(l[1]=b=>c.value.password=b),type:"password",name:"password",placeholder:t.$t("password"),"prefix-icon":m(be),"show-password":""},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),y.value?(k(),x(F,{key:1,prop:"shortMessageValue",rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(q,{modelValue:c.value.shortMessageValue,"onUpdate:modelValue":l[3]||(l[3]=b=>c.value.shortMessageValue=b),name:"shortMessageValue",placeholder:t.$t("shortMessage"),"prefix-icon":m(_e)},{append:o(()=>[a(K,{disabled:V.value<60,onClick:l[2]||(l[2]=()=>P.value=!0)},{default:o(()=>[A(T(S.value),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):D("",!0),n.value?(k(),x(F,{key:2,prop:"captcha",rules:[{required:!0,message:()=>t.$t("v.required")},{asyncValidator:async(b,te,H)=>{if(v.value==null||!await m(ee)(v.value,te)){H(t.$t("captchaIncorrect"));return}H()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(q,{modelValue:c.value.captcha,"onUpdate:modelValue":l[5]||(l[5]=b=>c.value.captcha=b),name:"captcha",placeholder:t.$t("captcha"),"prefix-icon":m(ae)},{append:o(()=>[a(le,{src:C.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:t.$t("clickToRetrieveCaptcha"),onClick:l[4]||(l[4]=()=>U())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):D("",!0),a(K,{type:"primary","native-type":"submit",class:"w-full",loading:_.value,onClick:z(N,["prevent"])},{default:o(()=>[A(T(t.$t("login")),1)]),_:1},8,["loading"]),R("div",xe,[a(K,{type:"primary",link:"",onClick:l[6]||(l[6]=()=>w.value=!0)},{default:o(()=>[A(T(t.$t("changePassword")),1)]),_:1})])]),_:1},8,["model"]),m(s)==="staging"?(k(),Q("div",Ie,l[9]||(l[9]=[R("p",null,"为避免数据被删改，演示用户登录后只拥有浏览后台功能，操作数据会显示无权访问（403）。",-1)]))):D("",!0),a(qe,{modelValue:w.value,"onUpdate:modelValue":l[7]||(l[7]=b=>w.value=b)},null,8,["modelValue"]),a(Ce,{modelValue:P.value,"onUpdate:modelValue":l[8]||(l[8]=b=>P.value=b),onFinish:f},null,8,["modelValue"])])}}}),De=ke(Le,[["__scopeId","data-v-577d108e"]]);export{De as default};
