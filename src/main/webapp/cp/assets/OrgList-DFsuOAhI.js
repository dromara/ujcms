import{d as ge,A as we,r as d,B as ye,b as M,c as Z,w as o,i as Le,h as l,g as be,j as Pe,k as i,u as Ee,$ as Q,ar as Te,o as De,l as S,aO as ze,v as P,x as E,m as Ie,t as ue,E as Re,b8 as Ke,b9 as Qe,b6 as Oe,bt as xe,bi as Ge,aw as je,aD as He,bu as Me,aH as Ze,bv as Ce,e as _e,Z as We,y as Je,aW as Xe,aZ as Ye,by as el,b5 as X,a3 as ll,bz as al,aP as tl,aQ as nl,ay as ol,bk as sl,bs as dl}from"./index-__TSAjOL.js";import{E as il,a as rl,b as ul}from"./el-main-CxOwtB5j.js";import{E as ml}from"./el-popover-B2t_MYt0.js";import{E as Se}from"./el-tree-CZELDHk3.js";import{E as cl}from"./el-switch-Cg-m0Y0i.js";import{S as pl}from"./sortable.esm-DEaZq8gs.js";import{c as vl,t as se,e as fl,f as me}from"./tree-CFBn_SXc.js";import{b as ce,z as Ue,A as bl,B as gl,C as qe,D as yl,E as hl,F as kl,G as Vl,H as $e,I as Cl}from"./user-Cc_GcFRq.js";import{E as _l,_ as $l,a as re,b as wl,c as Pl}from"./QueryItem.vue_vue_type_script_setup_true_lang-CDNlcHM_.js";import"./el-select-CPBsiljt.js";import{E as El}from"./el-tree-select-BM45XKJE.js";import{_ as Tl}from"./DialogForm.vue_vue_type_script_setup_true_lang-CYMSRniG.js";import{b as Dl}from"./data-CRNvglzJ.js";import{d as Il}from"./content-BqI55UAh.js";const Ol=ge({name:"OrgForm",__name:"OrgForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},beanIds:{type:Array,required:!0},parentId:{type:String,required:!0},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(x,{emit:G}){const U=x,{parentId:T,beanId:V,showGlobalData:C,modelValue:B}=we(U),F=G,D=d(),p=d({}),b=d([]),q=async m=>{b.value=vl(se(await ce({current:!C.value})),m==null?void 0:m.id)},L=async m=>{await q(m),F("finished")};return ye(B,()=>{B.value&&q()}),(m,r)=>{const z=El,_=Le,g=Pe;return M(),Z(Tl,{values:p.value,"onUpdate:values":r[5]||(r[5]=f=>p.value=f),name:m.$t("menu.user.org"),"query-bean":i(qe),"create-bean":i(gl),"update-bean":i(bl),"delete-bean":i(Ue),"bean-id":i(V),"bean-ids":x.beanIds,focus:D.value,"init-values":f=>({parentId:i(T)}),"to-values":f=>({...f}),"disable-delete":f=>{var $;return f.id<=1||f.id===(($=b.value[0])==null?void 0:$.id)},perms:"org","model-value":x.modelValue,"onUpdate:modelValue":r[6]||(r[6]=f=>m.$emit("update:modelValue",f)),onFinished:L,onBeanChange:r[7]||(r[7]=()=>q())},{default:o(({isEdit:f})=>{var $;return[!f||p.value.id!==(($=b.value[0])==null?void 0:$.id)?(M(),Z(_,{key:0,prop:"parentId",label:m.$t("org.parent"),rules:{required:!0,message:()=>m.$t("v.required")}},{default:o(()=>[l(z,{modelValue:p.value.parentId,"onUpdate:modelValue":r[0]||(r[0]=c=>p.value.parentId=c),data:b.value,"node-key":"id",props:{label:"name",disabled:"disabled"},"default-expanded-keys":b.value.map(c=>c.id),"render-after-expand":!1,disabled:f,"check-strictly":"",class:"w-full"},null,8,["modelValue","data","default-expanded-keys","disabled"])]),_:2},1032,["label","rules"])):be("",!0),l(_,{prop:"name",label:m.$t("org.name"),rules:{required:!0,message:()=>m.$t("v.required")}},{default:o(()=>[l(g,{ref_key:"focus",ref:D,modelValue:p.value.name,"onUpdate:modelValue":r[1]||(r[1]=c=>p.value.name=c),maxlength:"50"},null,8,["modelValue"])]),_:1},8,["label","rules"]),l(_,{prop:"address",label:m.$t("org.address")},{default:o(()=>[l(g,{modelValue:p.value.address,"onUpdate:modelValue":r[2]||(r[2]=c=>p.value.address=c),maxlength:"255"},null,8,["modelValue"])]),_:1},8,["label"]),l(_,{prop:"phone",label:m.$t("org.phone")},{default:o(()=>[l(g,{modelValue:p.value.phone,"onUpdate:modelValue":r[3]||(r[3]=c=>p.value.phone=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"]),l(_,{prop:"contacts",label:m.$t("org.contacts")},{default:o(()=>[l(g,{modelValue:p.value.contacts,"onUpdate:modelValue":r[4]||(r[4]=c=>p.value.contacts=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"])]}),_:1},8,["values","name","query-bean","create-bean","update-bean","delete-bean","bean-id","bean-ids","focus","init-values","to-values","disable-delete","model-value"])}}}),Sl={class:"border-t"},Ul={class:"border-t"},ql={class:"border-t"},Al={class:"flex items-center justify-between"},Nl=ge({name:"OrgPermissionForm",__name:"OrgPermissionForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(x,{emit:G}){var ie;const U=x,T=G,{beanId:V,modelValue:C}=we(U),{t:B}=Ee(),F=d("articlePermission"),D=d(),p=d({}),b=d({}),q=d(!1),L=d(!1),m=d(!1),r=d(),z=d(!1),_=d(!1),g=d(),f=d(!1),$=d(!1),c=d(),A=Dl();fl(A,(ie=Q.grantPermissions)!=null?ie:[]);const I=d([]),O=d([]),w=Te(()=>p.value.global&&!Q.globalPermission||Q.rank>p.value.rank),Y=async()=>{V.value!=null&&(p.value=await qe(V.value),b.value={...p.value})},pe=async()=>{var s;if(V.value!=null){const a=await yl(V.value);(s=r.value)==null||s.setCheckedKeys([]),a.forEach(h=>{var y;(y=r.value)==null||y.setChecked(h,!0,!1)})}},ve=async()=>{var s;if(V.value!=null){const a=await hl(V.value);(s=g.value)==null||s.setCheckedKeys([]),a.forEach(h=>{var y;(y=g.value)==null||y.setChecked(h,!0,!1)})}},ee=async()=>{var s;if(V.value!=null){const a=await kl(V.value,U.showGlobalData);(s=c.value)==null||s.setCheckedKeys([]),a.forEach(h=>{var y;(y=c.value)==null||y.setChecked(h,!0,!1)})}},fe=async()=>{I.value=se(await Il())},de=async()=>{O.value=se(await ce({current:!0}))};ye(C,async()=>{C.value&&(Y(),pe(),ve(),ee())}),De(()=>{fe(),de()});const le=()=>{D.value.validate(async s=>{if(s){q.value=!0;try{W(),te(),ne(),await Vl(b.value),T("finished"),T("update:modelValue",!1),ue.success(B("success"))}finally{q.value=!1}}})},j=(s,a,h,y)=>{h.forEach(e=>{e.children&&(a.getNode(e[y]).expanded=s,j(s,a,e.children,y))})},ae=(s,a,h,y)=>{a.setCheckedKeys(s?h.map(e=>e[y]):[])},W=()=>{r.value!=null&&(b.value.articlePermissions=[...r.value.getCheckedNodes(),...r.value.getHalfCheckedNodes()].map(s=>s.id))},te=()=>{g.value!=null&&(b.value.channelPermissions=[...g.value.getCheckedNodes(),...g.value.getHalfCheckedNodes()].map(s=>s.id))},ne=()=>{c.value!=null&&(b.value.orgPermissions=c.value.getCheckedNodes().map(s=>s.id))};return(s,a)=>{const h=Oe,y=Se,e=Qe,t=Ke,k=Re,v=ze,H=Ie,N=_l;return M(),Z(N,{title:s.$t("permissionSettings"),"with-header":!1,"model-value":x.modelValue,size:576,"onUpdate:modelValue":a[18]||(a[18]=n=>s.$emit("update:modelValue",n))},{default:o(()=>[l(k,{ref_key:"form",ref:D,model:b.value,disabled:w.value,"label-width":"150px"},{default:o(()=>[l(t,{modelValue:F.value,"onUpdate:modelValue":a[15]||(a[15]=n=>F.value=n)},{default:o(()=>[l(e,{label:s.$t("org.articlePermission"),name:"articlePermission"},{default:o(()=>[S("div",Sl,[l(h,{modelValue:L.value,"onUpdate:modelValue":a[0]||(a[0]=n=>L.value=n),label:s.$t("expand/collapse"),onChange:a[1]||(a[1]=n=>j(n,r.value,I.value,"id"))},null,8,["modelValue","label"]),l(h,{modelValue:m.value,"onUpdate:modelValue":a[2]||(a[2]=n=>m.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[3]||(a[3]=n=>{ae(n,r.value,i(me)(I.value),"id"),W()})},null,8,["modelValue","label"])]),l(y,{ref_key:"articlePermissionTree",ref:r,data:I.value,"node-key":"id",props:{label:"name"},class:"border rounded","show-checkbox":"",onCheck:a[4]||(a[4]=()=>W())},null,8,["data"])]),_:1},8,["label"]),l(e,{label:s.$t("role.channelPermission"),name:"channelPermission"},{default:o(()=>[S("div",Ul,[l(h,{modelValue:z.value,"onUpdate:modelValue":a[5]||(a[5]=n=>z.value=n),label:s.$t("expand/collapse"),onChange:a[6]||(a[6]=n=>j(n,g.value,I.value,"id"))},null,8,["modelValue","label"]),l(h,{modelValue:_.value,"onUpdate:modelValue":a[7]||(a[7]=n=>_.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[8]||(a[8]=n=>{ae(n,g.value,i(me)(I.value),"id"),te()})},null,8,["modelValue","label"])]),l(y,{ref_key:"channelPermissionTree",ref:g,data:I.value,"node-key":"id",props:{label:"name"},class:"border rounded","check-strictly":"","show-checkbox":"",onCheck:a[9]||(a[9]=()=>te())},null,8,["data"])]),_:1},8,["label"]),l(e,{label:s.$t("org.orgPermission"),name:"orgPermission"},{default:o(()=>[S("div",ql,[l(h,{modelValue:f.value,"onUpdate:modelValue":a[10]||(a[10]=n=>f.value=n),label:s.$t("expand/collapse"),onChange:a[11]||(a[11]=n=>j(n,c.value,O.value,"id"))},null,8,["modelValue","label"]),l(h,{modelValue:$.value,"onUpdate:modelValue":a[12]||(a[12]=n=>$.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[13]||(a[13]=n=>{ae(n,c.value,i(me)(O.value),"id"),ne()})},null,8,["modelValue","label"])]),l(y,{ref_key:"orgPermissionTree",ref:c,data:O.value,"node-key":"id",props:{label:"name"},class:"border rounded","default-expanded-keys":O.value.map(n=>n.id),"show-checkbox":"","check-strictly":"",onCheck:a[14]||(a[14]=()=>ne())},null,8,["data","default-expanded-keys"])]),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["model","disabled"])]),footer:o(()=>[S("div",Al,[S("div",null,[l(v,null,{default:o(()=>{var n;return[P(E((n=b.value)==null?void 0:n.name),1)]}),_:1})]),S("div",null,[l(H,{onClick:a[16]||(a[16]=()=>s.$emit("update:modelValue",!1))},{default:o(()=>[P(E(s.$t("cancel")),1)]),_:1}),l(H,{type:"primary",loading:q.value,disabled:w.value,onClick:a[17]||(a[17]=()=>le())},{default:o(()=>[P(E(s.$t("save")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["title","model-value"])}}}),Bl={class:"flex justify-between mx-2 mt-1"},Fl={class:"mb-3"},Ll={class:"mt-3 app-block"},ea=ge({name:"OrgList",__name:"OrgList",setup(x){const{t:G}=Ee(),U=d({}),T=d(),V=d(),C=d([]),B=d([]),F=d(!1),D=d(!1),p=d(!1),b=d(),q=Te(()=>me(C.value).map(e=>e.id)),L=d("1"),m=d(!1),r=d(),z=d(!1),_=d(!1),g=d(),f=d([]),$=d(!1),c=d(),A=d();ye(c,e=>{g.value.filter(e)});const I=async()=>{$.value=!0;try{f.value=se(await ce({current:!m.value})),xe(()=>{var e;c.value!=null&&g.value.filter(c.value),g.value.setCurrentKey((e=A.value)==null?void 0:e.id)})}finally{$.value=!1}},O=async()=>{var e,t;F.value=!0;try{z.value=T.value!==void 0;const k=Object.values(U.value).filter(v=>v!==void 0&&v!=="").length>0;C.value=await ce({...Ge(U.value),parentId:(e=A.value)==null?void 0:e.id,current:!m.value,isIncludeSelf:!0,isIncludeChildren:k,Q_OrderBy:T.value}),!k&&!z.value?(C.value=se(C.value),r.value=C.value.map(v=>v.id)):r.value=void 0,L.value=(t=C.value[0])==null?void 0:t.id}finally{F.value=!1}},w=()=>{I(),O()};let Y;const pe=()=>{const e=document.querySelector("#dataTable .el-table__body-wrapper tbody");Y=pl.create(e,{handle:".drag-handle",draggable:".drag-draggable",animation:200,chosenClass:"sortable-chosen",onEnd:async function(t){var H;const{oldIndex:k,newIndex:v}=t;if(k!==v){let N=k,n=v,R=C.value;const J=(H=R[0])==null?void 0:H.children;(J==null?void 0:J.length)>0&&(R=J,N-=1,n-=1),await $e(R[N].id,R[n].id,N>n?"before":"after"),I(),R.splice(n,0,R.splice(N,1)[0]),ue.success(G("success"))}}})};De(()=>{w(),pe()}),je(()=>{Y!==void 0&&Y.destroy()});const ve=({column:e,prop:t,order:k})=>{var v;t&&k?T.value=((v=e.sortBy)!=null?v:t)+(k==="descending"?"_desc":""):T.value=void 0,w()},ee=()=>O(),fe=()=>{V.value.clearSort(),dl(U.value),T.value=void 0,w()},de=e=>{b.value=void 0,e!=null&&(L.value=e),D.value=!0},le=e=>{b.value=e,D.value=!0},j=async e=>{await Ue(e),w(),ue.success(G("success"))},ae=e=>{b.value=e,p.value=!0},W=e=>e.id>1,te=async(e,t,k)=>{k!=="none"&&(await $e(e.data.id,t.data.id,k),O())},ne=async()=>{await Cl(),w(),ue.success(G("success"))},ie=async e=>{_.value?(A.value!=e.parent&&(A.value=e.parent,await O()),le(e.id)):(A.value=e,ee())},s=(e,t)=>e?t.name.includes(e):!0,a=()=>{g.value.setCurrentKey(null),A.value=void 0,ee()},h=e=>f.value.findIndex(t=>t.id===e.data.id)===-1,y=(e,t)=>f.value.findIndex(k=>k.id===t.data.id)===-1;return(e,t)=>{const k=Pe,v=Ie,H=cl,N=Ze,n=Se,R=He,J=il,he=ml,ke=ll,Ae=Oe,K=nl,Ne=tl,Be=rl,Fe=ul,Ve=Je;return M(),Z(Fe,null,{default:o(()=>[l(J,{width:"220px",class:"pr-3"},{default:o(()=>[l(R,{class:"p-2 bg-white rounded-sm"},{default:o(()=>[l(k,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=u=>c.value=u),"suffix-icon":i(Me),size:"small"},null,8,["modelValue","suffix-icon"]),S("div",Bl,[l(v,{type:A.value==null?"primary":void 0,link:"",onClick:a},{default:o(()=>[P(E(e.$t("org.root")),1)]),_:1},8,["type"]),l(N,{content:e.$t("editMode"),placement:"top"},{default:o(()=>[l(H,{modelValue:_.value,"onUpdate:modelValue":t[1]||(t[1]=u=>_.value=u),"active-action-icon":i(Ce),"inactive-action-icon":i(Ce)},null,8,["modelValue","active-action-icon","inactive-action-icon"])]),_:1},8,["content"])]),_e(l(n,{ref_key:"orgTree",ref:g,data:f.value,props:{label:"name"},"default-expanded-keys":r.value,"expand-on-click-node":!1,"node-key":"id","highlight-current":"",draggable:i(We)("org:update"),"allow-drag":h,"allow-drop":y,"filter-node-method":s,onNodeClick:ie,onNodeDragEnd:te},null,8,["data","default-expanded-keys","draggable"]),[[Ve,$.value]])]),_:1})]),_:1}),l(Be,{class:"p-0"},{default:o(()=>[S("div",Fl,[l(i($l),{params:U.value,onSearch:ee,onReset:fe},{default:o(()=>[l(i(re),{label:e.$t("org.name"),name:"Q_Contains_name"},null,8,["label"]),l(i(re),{label:e.$t("org.address"),name:"Q_Contains_address"},null,8,["label"]),l(i(re),{label:e.$t("org.phone"),name:"Q_Contains_phone"},null,8,["label"]),l(i(re),{label:e.$t("org.contacts"),name:"Q_Contains_contacts"},null,8,["label"])]),_:1},8,["params"])]),S("div",null,[l(v,{type:"primary",icon:i(Xe),onClick:t[2]||(t[2]=()=>de())},{default:o(()=>[P(E(e.$t("add")),1)]),_:1},8,["icon"]),l(he,{title:e.$t("confirmDelete"),onConfirm:t[3]||(t[3]=()=>j(B.value.map(u=>u.id)))},{reference:o(()=>[l(v,{disabled:B.value.length<=0,icon:i(Ye)},{default:o(()=>[P(E(e.$t("delete")),1)]),_:1},8,["disabled","icon"])]),_:1},8,["title"]),l(v,{disabled:i(X)("org:tidyTree"),icon:i(el),onClick:t[4]||(t[4]=()=>ne())},{default:o(()=>[P(E(e.$t("tidyTree")),1)]),_:1},8,["disabled","icon"]),l(N,{placement:"top",content:e.$t("tidyTree.tooltip")},{default:o(()=>[l(ke,{class:"ml-1 text-base align-text-bottom"},{default:o(()=>[l(i(al))]),_:1})]),_:1},8,["content"]),i(Q).globalPermission?(M(),Z(Ae,{key:0,modelValue:m.value,"onUpdate:modelValue":t[5]||(t[5]=u=>m.value=u),class:"ml-2 align-middle",label:e.$t("globalData"),border:!0,onChange:t[6]||(t[6]=()=>w())},null,8,["modelValue","label"])):be("",!0),l(i(wl),{name:"org",class:"ml-2"})]),S("div",Ll,[_e((M(),Z(Ne,{id:"dataTable",ref_key:"table",ref:V,"row-key":"id","default-expand-all":"",data:C.value,"row-class-name":({row:u})=>{var oe;return((oe=u.children)==null?void 0:oe.length)>0||u.id==="0"||u.id==="1"?void 0:"drag-draggable"},onSelectionChange:t[7]||(t[7]=u=>B.value=u),onRowDblclick:t[8]||(t[8]=u=>le(u.id)),onSortChange:ve},{default:o(()=>[l(i(Pl),{name:"org"},{default:o(()=>[l(K,{type:"selection",selectable:W,width:"45"}),l(K,{property:"name",label:e.$t("org.name"),sortable:"custom","min-width":"120"},null,8,["label"]),l(K,{property:"address",label:e.$t("org.address"),sortable:"custom",display:"none","min-width":"100"},null,8,["label"]),l(K,{property:"phone",label:e.$t("org.phone"),sortable:"custom","min-width":"100"},null,8,["label"]),l(K,{property:"contacts",label:e.$t("org.contacts"),sortable:"custom"},null,8,["label"]),l(K,{property:"id",label:"ID",width:"170",sortable:"custom"}),l(K,{width:"42"},{default:o(({row:u})=>{var oe;return[l(ke,{class:ol(["text-lg align-middle",z.value||i(X)("org:update")||((oe=u.children)==null?void 0:oe.length)>0||u.id==="0"||u.id==="1"?["cursor-not-allowed","text-gray-disabled"]:["cursor-move","text-gray-secondary","drag-handle"]])},{default:o(()=>[l(i(sl))]),_:2},1032,["class"])]}),_:1}),l(K,{label:e.$t("table.action"),width:"240"},{default:o(({row:u})=>[l(v,{type:"primary",disabled:i(X)("org:create"),size:"small",link:"",onClick:()=>de(u.id)},{default:o(()=>[P(E(e.$t("addChild")),1)]),_:2},1032,["disabled","onClick"]),l(v,{type:"primary",disabled:i(X)("org:update"),size:"small",link:"",onClick:()=>le(u.id)},{default:o(()=>[P(E(e.$t("edit")),1)]),_:2},1032,["disabled","onClick"]),i(Q).epRank>=3||i(Q).epDisplay?(M(),Z(v,{key:0,title:i(Q).epRank<3?e.$t("error.enterprise.short"):void 0,disabled:i(X)("org:updatePermission")||i(Q).epRank<3,type:"primary",size:"small",link:"",onClick:()=>ae(u.id)},{default:o(()=>[P(E(e.$t("permissionSettings")),1)]),_:2},1032,["title","disabled","onClick"])):be("",!0),l(he,{title:e.$t("confirmDelete"),onConfirm:()=>j([u.id])},{reference:o(()=>[l(v,{type:"primary",disabled:!W(u)||i(X)("org:delete"),size:"small",link:""},{default:o(()=>[P(E(e.$t("delete")),1)]),_:2},1032,["disabled"])]),_:2},1032,["title","onConfirm"])]),_:1},8,["label"])]),_:1})]),_:1},8,["data","row-class-name"])),[[Ve,F.value]])]),l(Ol,{modelValue:D.value,"onUpdate:modelValue":t[9]||(t[9]=u=>D.value=u),"bean-id":b.value,"bean-ids":q.value,"parent-id":L.value,"show-global-data":m.value,onFinished:w},null,8,["modelValue","bean-id","bean-ids","parent-id","show-global-data"]),l(Nl,{modelValue:p.value,"onUpdate:modelValue":t[10]||(t[10]=u=>p.value=u),"bean-id":b.value,"show-global-data":m.value,onFinished:w},null,8,["modelValue","bean-id","show-global-data"])]),_:1})]),_:1})}}});export{ea as default};
