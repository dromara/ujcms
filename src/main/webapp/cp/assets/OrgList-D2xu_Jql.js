import{d as me,A as Se,r as d,B as ce,b as B,c as F,w as o,i as Oe,h as a,g as Z,j as pe,k as t,_ as qe,u as Ue,ar as Be,o as Fe,bt as Ne,bi as Pe,t as X,aw as ze,aD as Le,bu as Re,l as G,m as Ae,v as V,x as $,aH as Qe,bv as re,e as ie,Z as xe,y as Me,aW as je,aZ as Ge,by as Ke,b5 as U,a3 as Ze,bz as He,$ as Q,b6 as We,aP as Je,aQ as Xe,ay as Ye,bk as ea,bs as aa}from"./index-Cf36YWNS.js";import{E as la,a as ta,b as na}from"./el-main-BFCPEsoI.js";import{E as oa}from"./el-popover-C_0N7hfY.js";import{E as sa}from"./el-tree-DlpQUTEg.js";import{E as da}from"./el-switch-B9SQC8Jd.js";import{S as ra}from"./sortable.esm-DEaZq8gs.js";import{c as ia,t as Y,f as ua}from"./tree-CFBn_SXc.js";import{q as ee,z as fe,A as ma,B as ca,C as pa,D as ue,E as fa}from"./user-BvrGnoRL.js";import{_ as ba,a as K,b as va,c as ga}from"./QueryItem.vue_vue_type_script_setup_true_lang-CxbrKWQZ.js";import"./el-select-CZiz7zhO.js";import{E as ya}from"./el-tree-select-D_WUNYbC.js";import{_ as _a}from"./DialogForm.vue_vue_type_script_setup_true_lang-CF04jdN3.js";const ha=me({name:"OrgForm",__name:"OrgForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},beanIds:{type:Array,required:!0},parentId:{type:String,required:!0},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(N,{emit:D}){const T=N,{parentId:w,beanId:x,showGlobalData:b,modelValue:S}=Se(T),P=D,C=d(),u=d({}),f=d([]),z=async s=>{f.value=ia(Y(await ee({current:!b.value})),s==null?void 0:s.id)},L=async s=>{await z(s),P("finished")};return ce(S,()=>{S.value&&z()}),(s,r)=>{const R=ya,g=Oe,v=pe;return B(),F(_a,{values:u.value,"onUpdate:values":r[5]||(r[5]=m=>u.value=m),name:s.$t("menu.user.org"),"query-bean":t(pa),"create-bean":t(ca),"update-bean":t(ma),"delete-bean":t(fe),"bean-id":t(x),"bean-ids":N.beanIds,focus:C.value,"init-values":m=>({parentId:t(w)}),"to-values":m=>({...m}),"disable-delete":m=>{var y;return m.id<=1||m.id===((y=f.value[0])==null?void 0:y.id)},perms:"org","model-value":N.modelValue,"onUpdate:modelValue":r[6]||(r[6]=m=>s.$emit("update:modelValue",m)),onFinished:L,onBeanChange:r[7]||(r[7]=()=>z())},{default:o(({isEdit:m})=>{var y;return[!m||u.value.id!==((y=f.value[0])==null?void 0:y.id)?(B(),F(g,{key:0,prop:"parentId",label:s.$t("org.parent"),rules:{required:!0,message:()=>s.$t("v.required")}},{default:o(()=>[a(R,{modelValue:u.value.parentId,"onUpdate:modelValue":r[0]||(r[0]=c=>u.value.parentId=c),data:f.value,"node-key":"id",props:{label:"name",disabled:"disabled"},"default-expanded-keys":f.value.map(c=>c.id),"render-after-expand":!1,disabled:m,"check-strictly":"",class:"w-full"},null,8,["modelValue","data","default-expanded-keys","disabled"])]),_:2},1032,["label","rules"])):Z("",!0),a(g,{prop:"name",label:s.$t("org.name"),rules:{required:!0,message:()=>s.$t("v.required")}},{default:o(()=>[a(v,{ref_key:"focus",ref:C,modelValue:u.value.name,"onUpdate:modelValue":r[1]||(r[1]=c=>u.value.name=c),maxlength:"50"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(g,{prop:"address",label:s.$t("org.address")},{default:o(()=>[a(v,{modelValue:u.value.address,"onUpdate:modelValue":r[2]||(r[2]=c=>u.value.address=c),maxlength:"255"},null,8,["modelValue"])]),_:1},8,["label"]),a(g,{prop:"phone",label:s.$t("org.phone")},{default:o(()=>[a(v,{modelValue:u.value.phone,"onUpdate:modelValue":r[3]||(r[3]=c=>u.value.phone=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"]),a(g,{prop:"contacts",label:s.$t("org.contacts")},{default:o(()=>[a(v,{modelValue:u.value.contacts,"onUpdate:modelValue":r[4]||(r[4]=c=>u.value.contacts=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"])]}),_:1},8,["values","name","query-bean","create-bean","update-bean","delete-bean","bean-id","bean-ids","focus","init-values","to-values","disable-delete","model-value"])}}}),ka={};function Va(N,D){return Z("",!0)}const $a=qe(ka,[["render",Va]]),wa={class:"flex justify-between mx-2 mt-1"},Ca={class:"mb-3"},Ea={class:"mt-3 app-block"},La=me({name:"OrgList",__name:"OrgList",setup(N){const{t:D}=Ue(),T=d({}),w=d(),x=d(),b=d([]),S=d([]),P=d(!1),C=d(!1),u=d(!1),f=d(),z=Be(()=>ua(b.value).map(e=>e.id)),L=d("1"),s=d(!1),r=d(),R=d(!1),g=d(!1),v=d(),m=d([]),y=d(!1),c=d(),E=d();ce(c,e=>{v.value.filter(e)});const ae=async()=>{y.value=!0;try{m.value=Y(await ee({current:!s.value})),Ne(()=>{var e;c.value!=null&&v.value.filter(c.value),v.value.setCurrentKey((e=E.value)==null?void 0:e.id)})}finally{y.value=!1}},M=async()=>{var e,l;P.value=!0;try{R.value=w.value!==void 0;const p=Object.values(T.value).filter(i=>i!==void 0&&i!=="").length>0;b.value=await ee({...Pe(T.value),parentId:(e=E.value)==null?void 0:e.id,current:!s.value,isIncludeSelf:!0,isIncludeChildren:p,Q_OrderBy:w.value}),!p&&!R.value?(b.value=Y(b.value),r.value=b.value.map(i=>i.id)):r.value=void 0,L.value=(l=b.value[0])==null?void 0:l.id}finally{P.value=!1}},_=()=>{ae(),M()};let H;const be=()=>{const e=document.querySelector("#dataTable .el-table__body-wrapper tbody");H=ra.create(e,{handle:".drag-handle",draggable:".drag-draggable",animation:200,chosenClass:"sortable-chosen",onEnd:async function(l){var j;const{oldIndex:p,newIndex:i}=l;if(p!==i){let I=p,O=i,h=b.value;const q=(j=h[0])==null?void 0:j.children;(q==null?void 0:q.length)>0&&(h=q,I-=1,O-=1),await ue(h[I].id,h[O].id,I>O?"before":"after"),ae(),h.splice(O,0,h.splice(I,1)[0]),X.success(D("success"))}}})};Fe(()=>{_(),be()}),ze(()=>{H!==void 0&&H.destroy()});const ve=({column:e,prop:l,order:p})=>{var i;l&&p?w.value=((i=e.sortBy)!=null?i:l)+(p==="descending"?"_desc":""):w.value=void 0,_()},W=()=>M(),ge=()=>{x.value.clearSort(),aa(T.value),w.value=void 0,_()},le=e=>{f.value=void 0,e!=null&&(L.value=e),C.value=!0},J=e=>{f.value=e,C.value=!0},te=async e=>{await fe(e),_(),X.success(D("success"))},ye=e=>{f.value=e,u.value=!0},ne=e=>e.id>1,_e=async(e,l,p)=>{p!=="none"&&(await ue(e.data.id,l.data.id,p),M())},he=async()=>{await fa(),_(),X.success(D("success"))},ke=async e=>{g.value?(E.value!=e.parent&&(E.value=e.parent,await M()),J(e.id)):(E.value=e,W())},Ve=(e,l)=>e?l.name.includes(e):!0,$e=()=>{v.value.setCurrentKey(null),E.value=void 0,W()},we=e=>m.value.findIndex(l=>l.id===e.data.id)===-1,Ce=(e,l)=>m.value.findIndex(p=>p.id===l.data.id)===-1;return(e,l)=>{const p=pe,i=Ae,j=da,I=Qe,O=sa,h=Le,q=la,oe=oa,se=Ze,Ee=We,k=Xe,Ie=Je,De=ta,Te=na,de=Me;return B(),F(Te,null,{default:o(()=>[a(q,{width:"220px",class:"pr-3"},{default:o(()=>[a(h,{class:"p-2 bg-white rounded-sm"},{default:o(()=>[a(p,{modelValue:c.value,"onUpdate:modelValue":l[0]||(l[0]=n=>c.value=n),"suffix-icon":t(Re),size:"small"},null,8,["modelValue","suffix-icon"]),G("div",wa,[a(i,{type:E.value==null?"primary":void 0,link:"",onClick:$e},{default:o(()=>[V($(e.$t("org.root")),1)]),_:1},8,["type"]),a(I,{content:e.$t("editMode"),placement:"top"},{default:o(()=>[a(j,{modelValue:g.value,"onUpdate:modelValue":l[1]||(l[1]=n=>g.value=n),"active-action-icon":t(re),"inactive-action-icon":t(re)},null,8,["modelValue","active-action-icon","inactive-action-icon"])]),_:1},8,["content"])]),ie(a(O,{ref_key:"orgTree",ref:v,data:m.value,props:{label:"name"},"default-expanded-keys":r.value,"expand-on-click-node":!1,"node-key":"id","highlight-current":"",draggable:t(xe)("org:update"),"allow-drag":we,"allow-drop":Ce,"filter-node-method":Ve,onNodeClick:ke,onNodeDragEnd:_e},null,8,["data","default-expanded-keys","draggable"]),[[de,y.value]])]),_:1})]),_:1}),a(De,{class:"p-0"},{default:o(()=>[G("div",Ca,[a(t(ba),{params:T.value,onSearch:W,onReset:ge},{default:o(()=>[a(t(K),{label:e.$t("org.name"),name:"Q_Contains_name"},null,8,["label"]),a(t(K),{label:e.$t("org.address"),name:"Q_Contains_address"},null,8,["label"]),a(t(K),{label:e.$t("org.phone"),name:"Q_Contains_phone"},null,8,["label"]),a(t(K),{label:e.$t("org.contacts"),name:"Q_Contains_contacts"},null,8,["label"])]),_:1},8,["params"])]),G("div",null,[a(i,{type:"primary",icon:t(je),onClick:l[2]||(l[2]=()=>le())},{default:o(()=>[V($(e.$t("add")),1)]),_:1},8,["icon"]),a(oe,{title:e.$t("confirmDelete"),onConfirm:l[3]||(l[3]=()=>te(S.value.map(n=>n.id)))},{reference:o(()=>[a(i,{disabled:S.value.length<=0,icon:t(Ge)},{default:o(()=>[V($(e.$t("delete")),1)]),_:1},8,["disabled","icon"])]),_:1},8,["title"]),a(i,{disabled:t(U)("org:tidyTree"),icon:t(Ke),onClick:l[4]||(l[4]=()=>he())},{default:o(()=>[V($(e.$t("tidyTree")),1)]),_:1},8,["disabled","icon"]),a(I,{placement:"top",content:e.$t("tidyTree.tooltip")},{default:o(()=>[a(se,{class:"ml-1 text-base align-text-bottom"},{default:o(()=>[a(t(He))]),_:1})]),_:1},8,["content"]),t(Q).globalPermission?(B(),F(Ee,{key:0,modelValue:s.value,"onUpdate:modelValue":l[5]||(l[5]=n=>s.value=n),class:"ml-2 align-middle",label:e.$t("globalData"),border:!0,onChange:l[6]||(l[6]=()=>_())},null,8,["modelValue","label"])):Z("",!0),a(t(va),{name:"org",class:"ml-2"})]),G("div",Ea,[ie((B(),F(Ie,{id:"dataTable",ref_key:"table",ref:x,"row-key":"id","default-expand-all":"",data:b.value,"row-class-name":({row:n})=>{var A;return((A=n.children)==null?void 0:A.length)>0||n.id==="0"||n.id==="1"?void 0:"drag-draggable"},onSelectionChange:l[7]||(l[7]=n=>S.value=n),onRowDblclick:l[8]||(l[8]=n=>J(n.id)),onSortChange:ve},{default:o(()=>[a(t(ga),{name:"org"},{default:o(()=>[a(k,{type:"selection",selectable:ne,width:"45"}),a(k,{property:"name",label:e.$t("org.name"),sortable:"custom","min-width":"120"},null,8,["label"]),a(k,{property:"address",label:e.$t("org.address"),sortable:"custom",display:"none","min-width":"100"},null,8,["label"]),a(k,{property:"phone",label:e.$t("org.phone"),sortable:"custom","min-width":"100"},null,8,["label"]),a(k,{property:"contacts",label:e.$t("org.contacts"),sortable:"custom"},null,8,["label"]),a(k,{property:"id",label:"ID",width:"170",sortable:"custom"}),a(k,{width:"42"},{default:o(({row:n})=>{var A;return[a(se,{class:Ye(["text-lg align-middle",R.value||t(U)("org:update")||((A=n.children)==null?void 0:A.length)>0||n.id==="0"||n.id==="1"?["cursor-not-allowed","text-gray-disabled"]:["cursor-move","text-gray-secondary","drag-handle"]])},{default:o(()=>[a(t(ea))]),_:2},1032,["class"])]}),_:1}),a(k,{label:e.$t("table.action"),width:"240"},{default:o(({row:n})=>[a(i,{type:"primary",disabled:t(U)("org:create"),size:"small",link:"",onClick:()=>le(n.id)},{default:o(()=>[V($(e.$t("addChild")),1)]),_:2},1032,["disabled","onClick"]),a(i,{type:"primary",disabled:t(U)("org:update"),size:"small",link:"",onClick:()=>J(n.id)},{default:o(()=>[V($(e.$t("edit")),1)]),_:2},1032,["disabled","onClick"]),t(Q).epRank>=3||t(Q).epDisplay?(B(),F(i,{key:0,title:t(Q).epRank<3?e.$t("error.enterprise.short"):void 0,disabled:t(U)("org:updatePermission")||t(Q).epRank<3,type:"primary",size:"small",link:"",onClick:()=>ye(n.id)},{default:o(()=>[V($(e.$t("permissionSettings")),1)]),_:2},1032,["title","disabled","onClick"])):Z("",!0),a(oe,{title:e.$t("confirmDelete"),onConfirm:()=>te([n.id])},{reference:o(()=>[a(i,{type:"primary",disabled:!ne(n)||t(U)("org:delete"),size:"small",link:""},{default:o(()=>[V($(e.$t("delete")),1)]),_:2},1032,["disabled"])]),_:2},1032,["title","onConfirm"])]),_:1},8,["label"])]),_:1})]),_:1},8,["data","row-class-name"])),[[de,P.value]])]),a(ha,{modelValue:C.value,"onUpdate:modelValue":l[9]||(l[9]=n=>C.value=n),"bean-id":f.value,"bean-ids":z.value,"parent-id":L.value,"show-global-data":s.value,onFinished:_},null,8,["modelValue","bean-id","bean-ids","parent-id","show-global-data"]),a($a,{modelValue:u.value,"onUpdate:modelValue":l[10]||(l[10]=n=>u.value=n),"bean-id":f.value,"show-global-data":s.value,onFinished:_},null,8,["modelValue","bean-id","show-global-data"])]),_:1})]),_:1})}}});export{La as default};
