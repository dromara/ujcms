import{d as ye,p as Pe,r as d,v as he,b as p,e as J,f as W,w as o,i as l,h as ge,j as i,u as De,V as G,aa as Te,o as Ie,k as S,n as D,t as T,E as me,aJ as Ae,aA as Be,aB as Fe,c as Le,aK as ze,aL as Ce,g as $e,U as Ke,ae as Re,ai as xe,aO as Ge,aq as Z,aP as Qe,af as je,aD as He,aI as Me}from"./index-B6OoDg6B.js";import{S as Je}from"./sortable.esm-DEaZq8gs.js";import{c as We,t as de,e as Xe,f as ce}from"./tree-CFBn_SXc.js";import{b as pe,z as Oe,A as Ye,B as Ze,C as Ue,D as el,E as ll,F as al,G as tl,H as we,I as nl}from"./user-DGHrS2p0.js";import{_ as ol,a as ue,b as sl,c as dl}from"./QueryItem.vue_vue_type_script_setup_true_lang-Tf1Ym-Zs.js";import{_ as il}from"./DialogForm.vue_vue_type_script_setup_true_lang-BCAZsuC3.js";import{b as rl}from"./data-BgduHdtJ.js";import{d as ul}from"./content-2hwtLvQa.js";const ml=ye({name:"OrgForm",__name:"OrgForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},beanIds:{type:Array,required:!0},parentId:{type:String,required:!0},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(Q,{emit:j}){const E=Q,{parentId:I,beanId:_,showGlobalData:C,modelValue:F}=Pe(E),L=j,O=d(),v=d({}),g=d([]),N=async m=>{g.value=We(de(await pe({current:!C.value})),m==null?void 0:m.id)},z=async m=>{await N(m),L("finished")};return he(F,()=>{F.value&&N()}),(m,r)=>{const K=p("el-tree-select"),$=p("el-form-item"),y=p("el-input");return J(),W(il,{values:v.value,"onUpdate:values":r[5]||(r[5]=b=>v.value=b),name:m.$t("menu.user.org"),"query-bean":i(Ue),"create-bean":i(Ze),"update-bean":i(Ye),"delete-bean":i(Oe),"bean-id":i(_),"bean-ids":Q.beanIds,focus:O.value,"init-values":b=>({parentId:i(I)}),"to-values":b=>({...b}),"disable-delete":b=>{var w;return b.id<=1||b.id===((w=g.value[0])==null?void 0:w.id)},perms:"org","model-value":Q.modelValue,"onUpdate:modelValue":r[6]||(r[6]=b=>m.$emit("update:modelValue",b)),onFinished:z,onBeanChange:r[7]||(r[7]=()=>N())},{default:o(({isEdit:b})=>{var w;return[!b||v.value.id!==((w=g.value[0])==null?void 0:w.id)?(J(),W($,{key:0,prop:"parentId",label:m.$t("org.parent"),rules:{required:!0,message:()=>m.$t("v.required")}},{default:o(()=>[l(K,{modelValue:v.value.parentId,"onUpdate:modelValue":r[0]||(r[0]=c=>v.value.parentId=c),data:g.value,"node-key":"id",props:{label:"name",disabled:"disabled"},"default-expanded-keys":g.value.map(c=>c.id),"render-after-expand":!1,disabled:b,"check-strictly":"",class:"w-full"},null,8,["modelValue","data","default-expanded-keys","disabled"])]),_:2},1032,["label","rules"])):ge("",!0),l($,{prop:"name",label:m.$t("org.name"),rules:{required:!0,message:()=>m.$t("v.required")}},{default:o(()=>[l(y,{ref_key:"focus",ref:O,modelValue:v.value.name,"onUpdate:modelValue":r[1]||(r[1]=c=>v.value.name=c),maxlength:"50"},null,8,["modelValue"])]),_:1},8,["label","rules"]),l($,{prop:"address",label:m.$t("org.address")},{default:o(()=>[l(y,{modelValue:v.value.address,"onUpdate:modelValue":r[2]||(r[2]=c=>v.value.address=c),maxlength:"255"},null,8,["modelValue"])]),_:1},8,["label"]),l($,{prop:"phone",label:m.$t("org.phone")},{default:o(()=>[l(y,{modelValue:v.value.phone,"onUpdate:modelValue":r[3]||(r[3]=c=>v.value.phone=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"]),l($,{prop:"contacts",label:m.$t("org.contacts")},{default:o(()=>[l(y,{modelValue:v.value.contacts,"onUpdate:modelValue":r[4]||(r[4]=c=>v.value.contacts=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"])]}),_:1},8,["values","name","query-bean","create-bean","update-bean","delete-bean","bean-id","bean-ids","focus","init-values","to-values","disable-delete","model-value"])}}}),cl={class:"border-t"},pl={class:"border-t"},vl={class:"border-t"},fl={class:"flex items-center justify-between"},bl=ye({name:"OrgPermissionForm",__name:"OrgPermissionForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(Q,{emit:j}){var re;const E=Q,I=j,{beanId:_,modelValue:C}=Pe(E),{t:F}=De(),L=d("articlePermission"),O=d(),v=d({}),g=d({}),N=d(!1),z=d(!1),m=d(!1),r=d(),K=d(!1),$=d(!1),y=d(),b=d(!1),w=d(!1),c=d(),A=rl();Xe(A,(re=G.grantPermissions)!=null?re:[]);const U=d([]),q=d([]),P=Te(()=>v.value.global&&!G.globalPermission||G.rank>v.value.rank),ee=async()=>{_.value!=null&&(v.value=await Ue(_.value),g.value={...v.value})},ve=async()=>{var s;if(_.value!=null){const a=await el(_.value);(s=r.value)==null||s.setCheckedKeys([]),a.forEach(k=>{var h;(h=r.value)==null||h.setChecked(k,!0,!1)})}},fe=async()=>{var s;if(_.value!=null){const a=await ll(_.value);(s=y.value)==null||s.setCheckedKeys([]),a.forEach(k=>{var h;(h=y.value)==null||h.setChecked(k,!0,!1)})}},le=async()=>{var s;if(_.value!=null){const a=await al(_.value,E.showGlobalData);(s=c.value)==null||s.setCheckedKeys([]),a.forEach(k=>{var h;(h=c.value)==null||h.setChecked(k,!0,!1)})}},be=async()=>{U.value=de(await ul())},ie=async()=>{q.value=de(await pe({current:!0}))};he(C,async()=>{C.value&&(ee(),ve(),fe(),le())}),Ie(()=>{be(),ie()});const ae=()=>{O.value.validate(async s=>{if(s){N.value=!0;try{X(),ne(),oe(),await tl(g.value),I("finished"),I("update:modelValue",!1),me.success(F("success"))}finally{N.value=!1}}})},H=(s,a,k,h)=>{k.forEach(e=>{e.children&&(a.getNode(e[h]).expanded=s,H(s,a,e.children,h))})},te=(s,a,k,h)=>{a.setCheckedKeys(s?k.map(e=>e[h]):[])},X=()=>{r.value!=null&&(g.value.articlePermissions=[...r.value.getCheckedNodes(),...r.value.getHalfCheckedNodes()].map(s=>s.id))},ne=()=>{y.value!=null&&(g.value.channelPermissions=[...y.value.getCheckedNodes(),...y.value.getHalfCheckedNodes()].map(s=>s.id))},oe=()=>{c.value!=null&&(g.value.orgPermissions=c.value.getCheckedNodes().map(s=>s.id))};return(s,a)=>{const k=p("el-checkbox"),h=p("el-tree"),e=p("el-tab-pane"),t=p("el-tabs"),V=p("el-form"),f=p("el-tag"),M=p("el-button"),B=p("el-drawer");return J(),W(B,{title:s.$t("permissionSettings"),"with-header":!1,"model-value":Q.modelValue,size:576,"onUpdate:modelValue":a[18]||(a[18]=n=>s.$emit("update:modelValue",n))},{default:o(()=>[l(V,{ref_key:"form",ref:O,model:g.value,disabled:P.value,"label-width":"150px"},{default:o(()=>[l(t,{modelValue:L.value,"onUpdate:modelValue":a[15]||(a[15]=n=>L.value=n)},{default:o(()=>[l(e,{label:s.$t("org.articlePermission"),name:"articlePermission"},{default:o(()=>[S("div",cl,[l(k,{modelValue:z.value,"onUpdate:modelValue":a[0]||(a[0]=n=>z.value=n),label:s.$t("expand/collapse"),onChange:a[1]||(a[1]=n=>H(n,r.value,U.value,"id"))},null,8,["modelValue","label"]),l(k,{modelValue:m.value,"onUpdate:modelValue":a[2]||(a[2]=n=>m.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[3]||(a[3]=n=>{te(n,r.value,i(ce)(U.value),"id"),X()})},null,8,["modelValue","label"])]),l(h,{ref_key:"articlePermissionTree",ref:r,data:U.value,"node-key":"id",props:{label:"name"},class:"border rounded","show-checkbox":"",onCheck:a[4]||(a[4]=()=>X())},null,8,["data"])]),_:1},8,["label"]),l(e,{label:s.$t("role.channelPermission"),name:"channelPermission"},{default:o(()=>[S("div",pl,[l(k,{modelValue:K.value,"onUpdate:modelValue":a[5]||(a[5]=n=>K.value=n),label:s.$t("expand/collapse"),onChange:a[6]||(a[6]=n=>H(n,y.value,U.value,"id"))},null,8,["modelValue","label"]),l(k,{modelValue:$.value,"onUpdate:modelValue":a[7]||(a[7]=n=>$.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[8]||(a[8]=n=>{te(n,y.value,i(ce)(U.value),"id"),ne()})},null,8,["modelValue","label"])]),l(h,{ref_key:"channelPermissionTree",ref:y,data:U.value,"node-key":"id",props:{label:"name"},class:"border rounded","check-strictly":"","show-checkbox":"",onCheck:a[9]||(a[9]=()=>ne())},null,8,["data"])]),_:1},8,["label"]),l(e,{label:s.$t("org.orgPermission"),name:"orgPermission"},{default:o(()=>[S("div",vl,[l(k,{modelValue:b.value,"onUpdate:modelValue":a[10]||(a[10]=n=>b.value=n),label:s.$t("expand/collapse"),onChange:a[11]||(a[11]=n=>H(n,c.value,q.value,"id"))},null,8,["modelValue","label"]),l(k,{modelValue:w.value,"onUpdate:modelValue":a[12]||(a[12]=n=>w.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[13]||(a[13]=n=>{te(n,c.value,i(ce)(q.value),"id"),oe()})},null,8,["modelValue","label"])]),l(h,{ref_key:"orgPermissionTree",ref:c,data:q.value,"node-key":"id",props:{label:"name"},class:"border rounded","default-expanded-keys":q.value.map(n=>n.id),"show-checkbox":"","check-strictly":"",onCheck:a[14]||(a[14]=()=>oe())},null,8,["data","default-expanded-keys"])]),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["model","disabled"])]),footer:o(()=>[S("div",fl,[S("div",null,[l(f,null,{default:o(()=>{var n;return[D(T((n=g.value)==null?void 0:n.name),1)]}),_:1})]),S("div",null,[l(M,{onClick:a[16]||(a[16]=()=>s.$emit("update:modelValue",!1))},{default:o(()=>[D(T(s.$t("cancel")),1)]),_:1}),l(M,{type:"primary",loading:N.value,disabled:P.value,onClick:a[17]||(a[17]=()=>ae())},{default:o(()=>[D(T(s.$t("save")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["title","model-value"])}}}),gl={class:"flex justify-between mx-2 mt-1"},yl={class:"mb-3"},hl={class:"mt-3 app-block"},Tl=ye({name:"OrgList",__name:"OrgList",setup(Q){const{t:j}=De(),E=d({}),I=d(),_=d(),C=d([]),F=d([]),L=d(!1),O=d(!1),v=d(!1),g=d(),N=Te(()=>ce(C.value).map(e=>e.id)),z=d("1"),m=d(!1),r=d(),K=d(!1),$=d(!1),y=d(),b=d([]),w=d(!1),c=d(),A=d();he(c,e=>{y.value.filter(e)});const U=async()=>{w.value=!0;try{b.value=de(await pe({current:!m.value})),Ae(()=>{var e;c.value!=null&&y.value.filter(c.value),y.value.setCurrentKey((e=A.value)==null?void 0:e.id)})}finally{w.value=!1}},q=async()=>{var e,t;L.value=!0;try{K.value=I.value!==void 0;const V=Object.values(E.value).filter(f=>f!==void 0&&f!=="").length>0;C.value=await pe({...Be(E.value),parentId:(e=A.value)==null?void 0:e.id,current:!m.value,isIncludeSelf:!0,isIncludeChildren:V,Q_OrderBy:I.value}),!V&&!K.value?(C.value=de(C.value),r.value=C.value.map(f=>f.id)):r.value=void 0,z.value=(t=C.value[0])==null?void 0:t.id}finally{L.value=!1}},P=()=>{U(),q()};let ee;const ve=()=>{const e=document.querySelector("#dataTable .el-table__body-wrapper tbody");ee=Je.create(e,{handle:".drag-handle",draggable:".drag-draggable",animation:200,chosenClass:"sortable-chosen",onEnd:async function(t){var M;const{oldIndex:V,newIndex:f}=t;if(V!==f){let B=V,n=f,R=C.value;const Y=(M=R[0])==null?void 0:M.children;(Y==null?void 0:Y.length)>0&&(R=Y,B-=1,n-=1),await we(R[B].id,R[n].id,B>n?"before":"after"),U(),R.splice(n,0,R.splice(B,1)[0]),me.success(j("success"))}}})};Ie(()=>{P(),ve()}),Fe(()=>{ee!==void 0&&ee.destroy()});const fe=({column:e,prop:t,order:V})=>{var f;t&&V?I.value=((f=e.sortBy)!=null?f:t)+(V==="descending"?"_desc":""):I.value=void 0,P()},le=()=>q(),be=()=>{_.value.clearSort(),Me(E.value),I.value=void 0,P()},ie=e=>{g.value=void 0,e!=null&&(z.value=e),O.value=!0},ae=e=>{g.value=e,O.value=!0},H=async e=>{await Oe(e),P(),me.success(j("success"))},te=e=>{g.value=e,v.value=!0},X=e=>e.id>1,ne=async(e,t,V)=>{V!=="none"&&(await we(e.data.id,t.data.id,V),q())},oe=async()=>{await nl(),P(),me.success(j("success"))},re=async e=>{$.value?(A.value!=e.parent&&(A.value=e.parent,await q()),ae(e.id)):(A.value=e,le())},s=(e,t)=>e?t.name.includes(e):!0,a=()=>{y.value.setCurrentKey(null),A.value=void 0,le()},k=e=>b.value.findIndex(t=>t.id===e.data.id)===-1,h=(e,t)=>b.value.findIndex(V=>V.id===t.data.id)===-1;return(e,t)=>{const V=p("el-input"),f=p("el-button"),M=p("el-switch"),B=p("el-tooltip"),n=p("el-tree"),R=p("el-scrollbar"),Y=p("el-aside"),ke=p("el-popconfirm"),Ve=p("el-icon"),qe=p("el-checkbox"),x=p("el-table-column"),Se=p("el-table"),Ee=p("el-main"),Ne=p("el-container"),_e=Le("loading");return J(),W(Ne,null,{default:o(()=>[l(Y,{width:"220px",class:"pr-3"},{default:o(()=>[l(R,{class:"p-2 bg-white rounded-sm"},{default:o(()=>[l(V,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=u=>c.value=u),"suffix-icon":i(ze),size:"small"},null,8,["modelValue","suffix-icon"]),S("div",gl,[l(f,{type:A.value==null?"primary":void 0,link:"",onClick:a},{default:o(()=>[D(T(e.$t("org.root")),1)]),_:1},8,["type"]),l(B,{content:e.$t("editMode"),placement:"top"},{default:o(()=>[l(M,{modelValue:$.value,"onUpdate:modelValue":t[1]||(t[1]=u=>$.value=u),"active-action-icon":i(Ce),"inactive-action-icon":i(Ce)},null,8,["modelValue","active-action-icon","inactive-action-icon"])]),_:1},8,["content"])]),$e(l(n,{ref_key:"orgTree",ref:y,data:b.value,props:{label:"name"},"default-expanded-keys":r.value,"expand-on-click-node":!1,"node-key":"id","highlight-current":"",draggable:i(Ke)("org:update"),"allow-drag":k,"allow-drop":h,"filter-node-method":s,onNodeClick:re,onNodeDragEnd:ne},null,8,["data","default-expanded-keys","draggable"]),[[_e,w.value]])]),_:1})]),_:1}),l(Ee,{class:"p-0"},{default:o(()=>[S("div",yl,[l(i(ol),{params:E.value,onSearch:le,onReset:be},{default:o(()=>[l(i(ue),{label:e.$t("org.name"),name:"Q_Contains_name"},null,8,["label"]),l(i(ue),{label:e.$t("org.address"),name:"Q_Contains_address"},null,8,["label"]),l(i(ue),{label:e.$t("org.phone"),name:"Q_Contains_phone"},null,8,["label"]),l(i(ue),{label:e.$t("org.contacts"),name:"Q_Contains_contacts"},null,8,["label"])]),_:1},8,["params"])]),S("div",null,[l(f,{type:"primary",icon:i(Re),onClick:t[2]||(t[2]=()=>ie())},{default:o(()=>[D(T(e.$t("add")),1)]),_:1},8,["icon"]),l(ke,{title:e.$t("confirmDelete"),onConfirm:t[3]||(t[3]=()=>H(F.value.map(u=>u.id)))},{reference:o(()=>[l(f,{disabled:F.value.length<=0,icon:i(xe)},{default:o(()=>[D(T(e.$t("delete")),1)]),_:1},8,["disabled","icon"])]),_:1},8,["title"]),l(f,{disabled:i(Z)("org:tidyTree"),icon:i(Ge),onClick:t[4]||(t[4]=()=>oe())},{default:o(()=>[D(T(e.$t("tidyTree")),1)]),_:1},8,["disabled","icon"]),l(B,{placement:"top",content:e.$t("tidyTree.tooltip")},{default:o(()=>[l(Ve,{class:"ml-1 text-base align-text-bottom"},{default:o(()=>[l(i(Qe))]),_:1})]),_:1},8,["content"]),i(G).globalPermission?(J(),W(qe,{key:0,modelValue:m.value,"onUpdate:modelValue":t[5]||(t[5]=u=>m.value=u),class:"ml-2 align-middle",label:e.$t("globalData"),border:!0,onChange:t[6]||(t[6]=()=>P())},null,8,["modelValue","label"])):ge("",!0),l(i(sl),{name:"org",class:"ml-2"})]),S("div",hl,[$e((J(),W(Se,{id:"dataTable",ref_key:"table",ref:_,"row-key":"id","default-expand-all":"",data:C.value,"row-class-name":({row:u})=>{var se;return((se=u.children)==null?void 0:se.length)>0||u.id==="0"||u.id==="1"?void 0:"drag-draggable"},onSelectionChange:t[7]||(t[7]=u=>F.value=u),onRowDblclick:t[8]||(t[8]=u=>ae(u.id)),onSortChange:fe},{default:o(()=>[l(i(dl),{name:"org"},{default:o(()=>[l(x,{type:"selection",selectable:X,width:"45"}),l(x,{property:"name",label:e.$t("org.name"),sortable:"custom","min-width":"120"},null,8,["label"]),l(x,{property:"address",label:e.$t("org.address"),sortable:"custom",display:"none","min-width":"100"},null,8,["label"]),l(x,{property:"phone",label:e.$t("org.phone"),sortable:"custom","min-width":"100"},null,8,["label"]),l(x,{property:"contacts",label:e.$t("org.contacts"),sortable:"custom"},null,8,["label"]),l(x,{property:"id",label:"ID",width:"170",sortable:"custom"}),l(x,{width:"42"},{default:o(({row:u})=>{var se;return[l(Ve,{class:je(["text-lg align-middle",K.value||i(Z)("org:update")||((se=u.children)==null?void 0:se.length)>0||u.id==="0"||u.id==="1"?["cursor-not-allowed","text-gray-disabled"]:["cursor-move","text-gray-secondary","drag-handle"]])},{default:o(()=>[l(i(He))]),_:2},1032,["class"])]}),_:1}),l(x,{label:e.$t("table.action"),width:"230"},{default:o(({row:u})=>[l(f,{type:"primary",disabled:i(Z)("org:create"),size:"small",link:"",onClick:()=>ie(u.id)},{default:o(()=>[D(T(e.$t("addChild")),1)]),_:2},1032,["disabled","onClick"]),l(f,{type:"primary",disabled:i(Z)("org:update"),size:"small",link:"",onClick:()=>ae(u.id)},{default:o(()=>[D(T(e.$t("edit")),1)]),_:2},1032,["disabled","onClick"]),i(G).epRank>=3||i(G).epDisplay?(J(),W(f,{key:0,title:i(G).epRank<3?e.$t("error.enterprise.short"):void 0,disabled:i(Z)("org:updatePermission")||i(G).epRank<3,type:"primary",size:"small",link:"",onClick:()=>te(u.id)},{default:o(()=>[D(T(e.$t("permissionSettings")),1)]),_:2},1032,["title","disabled","onClick"])):ge("",!0),l(ke,{title:e.$t("confirmDelete"),onConfirm:()=>H([u.id])},{reference:o(()=>[l(f,{type:"primary",disabled:!X(u)||i(Z)("org:delete"),size:"small",link:""},{default:o(()=>[D(T(e.$t("delete")),1)]),_:2},1032,["disabled"])]),_:2},1032,["title","onConfirm"])]),_:1},8,["label"])]),_:1})]),_:1},8,["data","row-class-name"])),[[_e,L.value]])]),l(ml,{modelValue:O.value,"onUpdate:modelValue":t[9]||(t[9]=u=>O.value=u),"bean-id":g.value,"bean-ids":N.value,"parent-id":z.value,"show-global-data":m.value,onFinished:P},null,8,["modelValue","bean-id","bean-ids","parent-id","show-global-data"]),l(bl,{modelValue:v.value,"onUpdate:modelValue":t[10]||(t[10]=u=>v.value=u),"bean-id":g.value,"show-global-data":m.value,onFinished:P},null,8,["modelValue","bean-id","show-global-data"])]),_:1})]),_:1})}}});export{Tl as default};
