import{d as J,u as j,a as oe,r as e,o as W,q as X,b as i,c as re,e as k,f as x,w as o,g as ue,h as T,i as a,j as m,k as A,l as N,t as E,m as z,s as O,n as ne,E as Y,p as ie,v as de,x as pe,y as Z,z as ee,A as ae,B as me,C as ce,D as ve,F as fe,G as ge,H as we,I as Q,J as he,K as ye,L as Ve,M as be,N as _e,O as $e,P as Me,Q as ke,R as qe,_ as Ce}from"./index-BgkR3Um2.js";const Pe=J({name:"ChangePassword",__name:"ChangePassword",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null},setup(q,{emit:L}){const U=L,{t:c}=j(),g=oe(),n=e({}),h=e(),P=e(),v=e(!1),$=e(!1),y=e(""),_=e();W(async()=>{v.value=!0;try{y.value=await X()}finally{v.value=!1}});const M=()=>{h.value.validate(async r=>{if(r){$.value=!0;try{const d=O(n.value.password,y.value),u=O(n.value.newPassword,y.value),l=await ne({...n.value,password:d,newPassword:u,passwordAgain:void 0});if(l.status!==0){_.value=l.message;return}_.value=void 0,h.value.resetFields(),Y.success(c("success")),U("update:modelValue",!1)}finally{$.value=!1}}})};return(r,d)=>{const u=i("el-alert"),l=i("el-input"),w=i("el-form-item"),S=i("el-button"),V=i("el-form"),I=i("el-dialog"),D=re("loading");return k(),x(I,{title:r.$t("changePassword"),"model-value":q.modelValue,"onUpdate:modelValue":d[4]||(d[4]=p=>r.$emit("update:modelValue",p)),onOpened:d[5]||(d[5]=()=>{var p;(p=P.value)==null||p.focus(),h.value.resetFields()})},{default:o(()=>[ue((k(),x(V,{ref_key:"form",ref:h,model:n.value,"label-width":"150px","label-position":"right"},{default:o(()=>[_.value?(k(),x(u,{key:0,title:_.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):T("",!0),a(w,{prop:"username",label:r.$t("user.username"),rules:[{required:!0,message:()=>r.$t("v.required")}]},{default:o(()=>[a(l,{ref_key:"focus",ref:P,modelValue:n.value.username,"onUpdate:modelValue":d[0]||(d[0]=p=>n.value.username=p),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(w,{prop:"password",label:r.$t("user.origPassword"),rules:[{required:!0,message:()=>r.$t("v.required")}]},{default:o(()=>[a(l,{modelValue:n.value.password,"onUpdate:modelValue":d[1]||(d[1]=p=>n.value.password=p),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(w,{prop:"newPassword",label:r.$t("user.newPassword"),rules:[{required:!0,message:()=>r.$t("v.required")},{min:m(g).security.passwordMinLength,max:m(g).security.passwordMaxLength,message:()=>r.$t("user.error.passwordLength",{min:m(g).security.passwordMinLength,max:m(g).security.passwordMaxLength})},{pattern:new RegExp(m(g).security.passwordPattern),message:()=>r.$t("user.error.passwordPattern.".concat(m(g).security.passwordStrength))}]},{default:o(()=>[a(l,{modelValue:n.value.newPassword,"onUpdate:modelValue":d[2]||(d[2]=p=>n.value.newPassword=p),maxlength:m(g).security.passwordMaxLength,"show-password":""},null,8,["modelValue","maxlength"])]),_:1},8,["label","rules"]),a(w,{prop:"passwordAgain",label:r.$t("user.passwordAgain"),rules:[{required:!0,message:()=>r.$t("v.required")},{validator:(p,R,f)=>{if(R!==n.value.newPassword){f(r.$t("user.error.passwordNotMatch"));return}f()}}]},{default:o(()=>[a(l,{modelValue:n.value.passwordAgain,"onUpdate:modelValue":d[3]||(d[3]=p=>n.value.passwordAgain=p),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),A("div",null,[a(S,{loading:$.value,type:"primary","native-type":"submit",onClick:z(M,["prevent"])},{default:o(()=>[N(E(r.$t("submit")),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[D,v.value]])]),_:1},8,["title","model-value"])}}}),Se=J({name:"GetShortMessage",__name:"GetShortMessage",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finish:null},setup(q,{emit:L}){const U=q,c=L,{modelValue:g}=ie(U),{t:n}=j(),h=e(),P=e(),v=e({}),$=e(!1),y=e(),_=e(),M=e(),r=async()=>{const{token:u,image:l}=await ae();_.value="data:image/png;base64,"+l,M.value=u};de(g,()=>{g.value&&r()});const d=()=>{h.value.validate(async u=>{var l;if(u){$.value=!0;try{const w=await me((l=M.value)!=null?l:"",v.value.captcha,v.value.mobile,3);if(w.status!==0){y.value=w.message;return}y.value=void 0,h.value.resetFields(),Y.success(n("success")),c("finish",w.result.shortMessageId),c("update:modelValue",!1)}finally{$.value=!1}}})};return(u,l)=>{const w=i("el-alert"),S=i("el-input"),V=i("el-form-item"),I=i("el-image"),D=i("el-button"),p=i("el-form"),R=i("el-dialog");return k(),x(R,{title:u.$t("getShortMessage"),"model-value":q.modelValue,width:"576px","onUpdate:modelValue":l[3]||(l[3]=f=>u.$emit("update:modelValue",f)),onOpened:l[4]||(l[4]=()=>{var f;(f=P.value)==null||f.focus(),h.value.resetFields()})},{default:o(()=>[a(p,{ref_key:"form",ref:h,model:v.value,"label-width":"150px","label-position":"right"},{default:o(()=>[y.value?(k(),x(w,{key:0,title:y.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):T("",!0),a(V,{prop:"mobile",label:u.$t("mobile"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(f,B,s)=>{if(await m(pe)(B)){s(u.$t("mobileNotExist"));return}s()},trigger:"blur"}]},{default:o(()=>[a(S,{ref_key:"focus",ref:P,modelValue:v.value.mobile,"onUpdate:modelValue":l[0]||(l[0]=f=>v.value.mobile=f),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(V,{prop:"captcha",label:u.$t("captcha"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(f,B,s)=>{if(M.value==null||!await m(Z)(M.value,B)){s(u.$t("captchaIncorrect"));return}s()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(S,{modelValue:v.value.captcha,"onUpdate:modelValue":l[2]||(l[2]=f=>v.value.captcha=f),name:"captcha",placeholder:u.$t("captcha"),"prefix-icon":m(ee)},{append:o(()=>[a(I,{src:_.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:u.$t("clickToRetrieveCaptcha"),onClick:l[1]||(l[1]=()=>r())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["label","rules"]),A("div",null,[a(D,{loading:$.value,type:"primary","native-type":"submit",onClick:z(d,["prevent"])},{default:o(()=>[N(E(u.$t("submit")),1)]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1},8,["title","model-value"])}}}),Ie=q=>(ke("data-v-7624e2af"),q=q(),qe(),q),xe={class:"h-full p-3 bg-gray-100"},Le={class:"py-5 text-3xl font-bold text-center text-primary"},Ue={class:"mt-2 text-right"},De={key:0,class:"mt-5 text-sm text-center text-gray-secondary"},Te=Ie(()=>A("p",null,"为避免数据被删改，演示用户登录后只拥有浏览后台功能，操作数据会显示无权访问（403）。",-1)),Ee=[Te],Re=J({__name:"LoginPage",setup(q){const{t:L}=j(),U=e(),c=e({}),g=e(),n=e(!1),h=e(!1),P=e(),v=e(),$=e(),y=e(),_=e(!1),M=e(),r=ce(),d=ve(),u="UJCMS",l="production",w=e(!1),S=e(!1),V=e(60),I=e(L("getShortMessage"));fe(),ge();const D=async()=>{const{token:s,image:t}=await ae();P.value="data:image/png;base64,"+t,v.value=s},p=async()=>{n.value=await be(),n.value&&D()},R=async()=>{h.value=await _e()};W(async()=>{g.value.focus(),g.value.select(),p(),R()}),we(()=>{M.value=r.query.redirect});const f=s=>{$.value=s,V.value-=1,I.value=String(V.value);const t=setInterval(()=>{V.value-=1,I.value=String(V.value),V.value<=0&&(I.value=L("getShortMessage"),V.value=60,clearInterval(t))},1e3)},B=()=>{U.value.validate(async s=>{if(s){_.value=!0;try{const t=await X(),G=O(c.value.password,t),C=await $e({...c.value,password:G,captchaToken:v.value,shortMessageId:$.value});if(C.status!==0){p(),y.value=C.message;return}C.result.remainingDays!=null&&Me.alert(L("passwordRemaingDays",{remainingDays:C.result.remainingDays}),{type:"warning"}),M.value?d.push(M.value):window.location.reload()}finally{_.value=!1}}})};return(s,t)=>{const G=i("el-alert"),C=i("el-input"),F=i("el-form-item"),K=i("el-button"),le=i("el-image"),se=i("el-form");return k(),Q("div",xe,[A("h3",Le,E(m(u)),1),a(se,{ref_key:"form",ref:U,model:c.value,class:"mx-auto md:max-w-xs"},{default:o(()=>[y.value?(k(),x(G,{key:0,title:y.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):T("",!0),a(F,{prop:"username",rules:[{required:!0,message:()=>s.$t("v.required")}]},{default:o(()=>[a(C,{ref_key:"focus",ref:g,modelValue:c.value.username,"onUpdate:modelValue":t[0]||(t[0]=b=>c.value.username=b),name:"username",placeholder:s.$t("username"),"prefix-icon":m(he),autocomplete:"on"},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),a(F,{prop:"password",rules:[{required:!0,message:()=>s.$t("v.required")}]},{default:o(()=>[a(C,{ref:"password",modelValue:c.value.password,"onUpdate:modelValue":t[1]||(t[1]=b=>c.value.password=b),type:"password",name:"password",placeholder:s.$t("password"),"prefix-icon":m(ye),"show-password":""},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),h.value?(k(),x(F,{key:1,prop:"shortMessageValue",rules:[{required:!0,message:()=>s.$t("v.required")}]},{default:o(()=>[a(C,{modelValue:c.value.shortMessageValue,"onUpdate:modelValue":t[3]||(t[3]=b=>c.value.shortMessageValue=b),name:"shortMessageValue",placeholder:s.$t("shortMessage"),"prefix-icon":m(Ve)},{append:o(()=>[a(K,{disabled:V.value<60,onClick:t[2]||(t[2]=()=>S.value=!0)},{default:o(()=>[N(E(I.value),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):T("",!0),n.value?(k(),x(F,{key:2,prop:"captcha",rules:[{required:!0,message:()=>s.$t("v.required")},{asyncValidator:async(b,te,H)=>{if(v.value==null||!await m(Z)(v.value,te)){H(s.$t("captchaIncorrect"));return}H()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(C,{modelValue:c.value.captcha,"onUpdate:modelValue":t[5]||(t[5]=b=>c.value.captcha=b),name:"captcha",placeholder:s.$t("captcha"),"prefix-icon":m(ee)},{append:o(()=>[a(le,{src:P.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:s.$t("clickToRetrieveCaptcha"),onClick:t[4]||(t[4]=()=>D())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):T("",!0),a(K,{type:"primary","native-type":"submit",class:"w-full",loading:_.value,onClick:z(B,["prevent"])},{default:o(()=>[N(E(s.$t("login")),1)]),_:1},8,["loading"]),A("div",Ue,[a(K,{type:"primary",link:"",onClick:t[6]||(t[6]=()=>w.value=!0)},{default:o(()=>[N(E(s.$t("changePassword")),1)]),_:1})])]),_:1},8,["model"]),m(l)==="staging"?(k(),Q("div",De,Ee)):T("",!0),a(Pe,{modelValue:w.value,"onUpdate:modelValue":t[7]||(t[7]=b=>w.value=b)},null,8,["modelValue"]),a(Se,{modelValue:S.value,"onUpdate:modelValue":t[8]||(t[8]=b=>S.value=b),onFinish:f},null,8,["modelValue"])])}}}),Ne=Ce(Re,[["__scopeId","data-v-7624e2af"]]);export{Ne as default};
