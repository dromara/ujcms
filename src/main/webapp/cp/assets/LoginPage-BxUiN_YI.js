import{d as O,u as J,a as pe,r as e,o as ee,q as ae,b as M,c as I,w as o,e as me,E as j,f as z,g as U,h as a,i as H,j as Q,k as p,l as R,m as W,n as X,s as K,p as ce,t as le,v as A,x,y as ve,z as se,A as fe,B as ge,C as te,D as we,F as oe,G as re,H as ye,I as he,J as Ve,K as be,L as _e,M as $e,N as Me,O as ke,P as Z,Q as qe,R as Ce,S as Pe,T as Ie,U as Se,_ as Ee}from"./index-__TSAjOL.js";import{E as ue}from"./el-image-viewer-DHqUxZBa.js";import"./position-BrJTBGCI.js";const Le=O({name:"ChangePassword",__name:"ChangePassword",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null},setup(D,{emit:S}){const E=S,{t:m}=J(),f=pe(),n=e({}),w=e(),q=e(),c=e(!1),_=e(!1),y=e(""),b=e();ee(async()=>{c.value=!0;try{y.value=await ae()}finally{c.value=!1}});const $=()=>{w.value.validate(async r=>{if(r){_.value=!0;try{const i=K(n.value.password,y.value),u=K(n.value.newPassword,y.value),s=await ce({...n.value,password:i,newPassword:u,passwordAgain:void 0});if(s.status!==0){b.value=s.message;return}b.value=void 0,w.value.resetFields(),le.success(m("success")),E("update:modelValue",!1)}finally{_.value=!1}}})};return(r,i)=>{const u=z,s=Q,g=H,C=W,h=j,P=se,L=ve;return M(),I(P,{title:r.$t("changePassword"),"model-value":D.modelValue,"onUpdate:modelValue":i[4]||(i[4]=d=>r.$emit("update:modelValue",d)),onOpened:i[5]||(i[5]=()=>{var d;(d=q.value)==null||d.focus(),w.value.resetFields()})},{default:o(()=>[me((M(),I(h,{ref_key:"form",ref:w,model:n.value,"label-width":"150px","label-position":"right"},{default:o(()=>[b.value?(M(),I(u,{key:0,title:b.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):U("",!0),a(g,{prop:"username",label:r.$t("user.username"),rules:[{required:!0,message:()=>r.$t("v.required")}]},{default:o(()=>[a(s,{ref_key:"focus",ref:q,modelValue:n.value.username,"onUpdate:modelValue":i[0]||(i[0]=d=>n.value.username=d),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(g,{prop:"password",label:r.$t("user.origPassword"),rules:[{required:!0,message:()=>r.$t("v.required")}]},{default:o(()=>[a(s,{modelValue:n.value.password,"onUpdate:modelValue":i[1]||(i[1]=d=>n.value.password=d),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(g,{prop:"newPassword",label:r.$t("user.newPassword"),rules:[{required:!0,message:()=>r.$t("v.required")},{min:p(f).security.passwordMinLength,max:p(f).security.passwordMaxLength,message:()=>r.$t("user.error.passwordLength",{min:p(f).security.passwordMinLength,max:p(f).security.passwordMaxLength})},{pattern:new RegExp(p(f).security.passwordPattern),message:()=>r.$t("user.error.passwordPattern.".concat(p(f).security.passwordStrength))}]},{default:o(()=>[a(s,{modelValue:n.value.newPassword,"onUpdate:modelValue":i[2]||(i[2]=d=>n.value.newPassword=d),maxlength:p(f).security.passwordMaxLength,"show-password":""},null,8,["modelValue","maxlength"])]),_:1},8,["label","rules"]),a(g,{prop:"passwordAgain",label:r.$t("user.passwordAgain"),rules:[{required:!0,message:()=>r.$t("v.required")},{validator:(d,T,v)=>{if(T!==n.value.newPassword){v(r.$t("user.error.passwordNotMatch"));return}v()}}]},{default:o(()=>[a(s,{modelValue:n.value.passwordAgain,"onUpdate:modelValue":i[3]||(i[3]=d=>n.value.passwordAgain=d),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),R("div",null,[a(C,{loading:_.value,type:"primary","native-type":"submit",onClick:X($,["prevent"])},{default:o(()=>[A(x(r.$t("submit")),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[L,c.value]])]),_:1},8,["title","model-value"])}}}),Ue=O({name:"GetShortMessage",__name:"GetShortMessage",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finish:null},setup(D,{emit:S}){const E=D,m=S,{modelValue:f}=fe(E),{t:n}=J(),w=e(),q=e(),c=e({}),_=e(!1),y=e(),b=e(),$=e(),r=async()=>{const{token:u,image:s}=await te();b.value="data:image/png;base64,"+s,$.value=u};ge(f,()=>{f.value&&r()});const i=()=>{w.value.validate(async u=>{var s;if(u){_.value=!0;try{const g=await ye((s=$.value)!=null?s:"",c.value.captcha,c.value.mobile,3);if(g.status!==0){y.value=g.message;return}y.value=void 0,w.value.resetFields(),le.success(n("success")),m("finish",g.result.shortMessageId),m("update:modelValue",!1)}finally{_.value=!1}}})};return(u,s)=>{const g=z,C=Q,h=H,P=ue,L=W,d=j,T=se;return M(),I(T,{title:u.$t("getShortMessage"),"model-value":D.modelValue,width:"576px","onUpdate:modelValue":s[3]||(s[3]=v=>u.$emit("update:modelValue",v)),onOpened:s[4]||(s[4]=()=>{var v;(v=q.value)==null||v.focus(),w.value.resetFields()})},{default:o(()=>[a(d,{ref_key:"form",ref:w,model:c.value,"label-width":"150px","label-position":"right"},{default:o(()=>[y.value?(M(),I(g,{key:0,title:y.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):U("",!0),a(h,{prop:"mobile",label:u.$t("mobile"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(v,B,t)=>{if(await p(we)(B)){t(u.$t("mobileNotExist"));return}t()},trigger:"blur"}]},{default:o(()=>[a(C,{ref_key:"focus",ref:q,modelValue:c.value.mobile,"onUpdate:modelValue":s[0]||(s[0]=v=>c.value.mobile=v),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(h,{prop:"captcha",label:u.$t("captcha"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(v,B,t)=>{if($.value==null||!await p(oe)($.value,B)){t(u.$t("captchaIncorrect"));return}t()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(C,{modelValue:c.value.captcha,"onUpdate:modelValue":s[2]||(s[2]=v=>c.value.captcha=v),name:"captcha",placeholder:u.$t("captcha"),"prefix-icon":p(re)},{append:o(()=>[a(P,{src:b.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:u.$t("clickToRetrieveCaptcha"),onClick:s[1]||(s[1]=()=>r())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["label","rules"]),R("div",null,[a(L,{loading:_.value,type:"primary","native-type":"submit",onClick:X(i,["prevent"])},{default:o(()=>[A(x(u.$t("submit")),1)]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1},8,["title","model-value"])}}}),xe={class:"h-full p-3 bg-gray-100"},De={class:"py-5 text-3xl font-bold text-center text-primary"},Te={class:"mt-2 text-right"},Be={key:0,class:"mt-5 text-sm text-center text-gray-secondary"},Re=O({__name:"LoginPage",setup(D){const{t:S}=J(),E=e(),m=e({}),f=e(),n=e(!1),w=e(!1),q=e(),c=e(),_=e(),y=e(),b=e(!1),$=e(),r=he(),i=Ve(),u="UJCMS",s="production",g=e(!1),C=e(!1),h=e(60),P=e(S("getShortMessage"));be(),_e();const L=async()=>{const{token:t,image:l}=await te();q.value="data:image/png;base64,"+l,c.value=t},d=async()=>{n.value=await $e(),n.value&&L()},T=async()=>{w.value=await Me()};ee(async()=>{f.value.focus(),f.value.select(),d(),T()}),ke(()=>{$.value=r.query.redirect});const v=t=>{_.value=t,h.value-=1,P.value=String(h.value);const l=setInterval(()=>{h.value-=1,P.value=String(h.value),h.value<=0&&(P.value=S("getShortMessage"),h.value=60,clearInterval(l))},1e3)},B=()=>{E.value.validate(async t=>{if(t){b.value=!0;try{const l=await ae(),N=K(m.value.password,l),k=await Ie({...m.value,password:N,captchaToken:c.value,shortMessageId:_.value});if(k.status!==0){d(),y.value=k.message;return}k.result.remainingDays!=null&&Se.alert(S("passwordRemaingDays",{remainingDays:k.result.remainingDays}),{type:"warning"}),$.value?i.push($.value):window.location.reload()}finally{b.value=!1}}})};return(t,l)=>{const N=z,k=Q,F=H,G=W,ne=ue,ie=j;return M(),Z("div",xe,[R("h3",De,x(p(u)),1),a(ie,{ref_key:"form",ref:E,model:m.value,class:"mx-auto md:max-w-xs"},{default:o(()=>[y.value?(M(),I(N,{key:0,title:y.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):U("",!0),a(F,{prop:"username",rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(k,{ref_key:"focus",ref:f,modelValue:m.value.username,"onUpdate:modelValue":l[0]||(l[0]=V=>m.value.username=V),name:"username",placeholder:t.$t("username"),"prefix-icon":p(qe),autocomplete:"on"},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),a(F,{prop:"password",rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(k,{ref:"password",modelValue:m.value.password,"onUpdate:modelValue":l[1]||(l[1]=V=>m.value.password=V),type:"password",name:"password",placeholder:t.$t("password"),"prefix-icon":p(Ce),"show-password":""},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),w.value?(M(),I(F,{key:1,prop:"shortMessageValue",rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(k,{modelValue:m.value.shortMessageValue,"onUpdate:modelValue":l[3]||(l[3]=V=>m.value.shortMessageValue=V),name:"shortMessageValue",placeholder:t.$t("shortMessage"),"prefix-icon":p(Pe)},{append:o(()=>[a(G,{disabled:h.value<60,onClick:l[2]||(l[2]=()=>C.value=!0)},{default:o(()=>[A(x(P.value),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):U("",!0),n.value?(M(),I(F,{key:2,prop:"captcha",rules:[{required:!0,message:()=>t.$t("v.required")},{asyncValidator:async(V,de,Y)=>{if(c.value==null||!await p(oe)(c.value,de)){Y(t.$t("captchaIncorrect"));return}Y()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(k,{modelValue:m.value.captcha,"onUpdate:modelValue":l[5]||(l[5]=V=>m.value.captcha=V),name:"captcha",placeholder:t.$t("captcha"),"prefix-icon":p(re)},{append:o(()=>[a(ne,{src:q.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:t.$t("clickToRetrieveCaptcha"),onClick:l[4]||(l[4]=()=>L())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):U("",!0),a(G,{type:"primary","native-type":"submit",class:"w-full",loading:b.value,onClick:X(B,["prevent"])},{default:o(()=>[A(x(t.$t("login")),1)]),_:1},8,["loading"]),R("div",Te,[a(G,{type:"primary",link:"",onClick:l[6]||(l[6]=()=>g.value=!0)},{default:o(()=>[A(x(t.$t("changePassword")),1)]),_:1})])]),_:1},8,["model"]),p(s)==="staging"?(M(),Z("div",Be,l[9]||(l[9]=[R("p",null,"为避免数据被删改，演示用户登录后只拥有浏览后台功能，操作数据会显示无权访问（403）",-1)]))):U("",!0),a(Le,{modelValue:g.value,"onUpdate:modelValue":l[7]||(l[7]=V=>g.value=V)},null,8,["modelValue"]),a(Ue,{modelValue:C.value,"onUpdate:modelValue":l[8]||(l[8]=V=>C.value=V),onFinish:v},null,8,["modelValue"])])}}}),Ge=Ee(Re,[["__scopeId","data-v-6a121d66"]]);export{Ge as default};
